stages:
  - build

build-and-push:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - echo "Logging in to Docker Hub..."
    - echo "$DOCKERHUB_TOKEN" | docker login --username "$DOCKERHUB_USERNAME" --password-stdin
  script:
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        # Build and push with tag version
        docker build -t $DOCKERHUB_USERNAME/runpod-ingest:$CI_COMMIT_TAG .
        docker push $DOCKERHUB_USERNAME/runpod-ingest:$CI_COMMIT_TAG
        
        # Also tag and push as latest
        docker tag $DOCKERHUB_USERNAME/runpod-ingest:$CI_COMMIT_TAG $DOCKERHUB_USERNAME/runpod-ingest:latest
        docker push $DOCKERHUB_USERNAME/runpod-ingest:latest
        
        echo "✅ Pushed $DOCKERHUB_USERNAME/runpod-ingest:$CI_COMMIT_TAG"
        echo "✅ Pushed $DOCKERHUB_USERNAME/runpod-ingest:latest"
      else
        echo "⚠️ No tag found, skipping build"
      fi
  only:
    - tags
